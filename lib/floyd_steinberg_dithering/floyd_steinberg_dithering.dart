import 'dart:convert';
import 'dart:typed_data';

import 'dart:ui';

import 'package:umbra_flutter/umbra_flutter.dart';

/// {@template floyd_steinberg_dithering}
/// A Dart Shader class for the `floyd_steinberg_dithering` shader.
/// {@endtemplate}
class FloydSteinbergDithering extends UmbraShader {
  FloydSteinbergDithering._() : super(_cachedProgram!);

  /// {@macro floyd_steinberg_dithering}
  static Future<FloydSteinbergDithering> compile() async {
    try {
      // Caching the program on the first compile call.
      _cachedProgram ??= await FragmentProgram.compile(
        spirv: Uint8List.fromList(base64Decode(_spirv)).buffer,
      );

      return FloydSteinbergDithering._();
    } on Exception catch (err, stackTrace) {
      throw UmbraException(err, stackTrace);
    }
  }

  static FragmentProgram? _cachedProgram;

  Shader shader({
    required Size resolution,
    required Vector2 iResolution,
    required Image image,
  }) {
    return program.shader(
      floatUniforms: Float32List.fromList([
        iResolution.x,
        iResolution.y,
        resolution.width,
        resolution.height,
      ]),
      samplerUniforms: [
        ImageShader(
          image,
          TileMode.clamp,
          TileMode.clamp,
          UmbraShader.identity,
        ),
      ],
    );
  }
}

const _spirv =
    'AwIjBwAAAQAKAA0A8AAAAAAAAAARAAIAAQAAAAsABgABAAAAR0xTTC5zdGQuNDUwAAAAAA4AAwAAAAAAAQAAAA8ABwAEAAAABAAAAG1haW4AAAAA4gAAAOkAAAAQAAMABAAAAAgAAAADAAMAAQAAAEABAAAEAAoAR0xfR09PR0xFX2NwcF9zdHlsZV9saW5lX2RpcmVjdGl2ZQAABAAIAEdMX0dPT0dMRV9pbmNsdWRlX2RpcmVjdGl2ZQAFAAQABAAAAG1haW4AAAAABQAHAA0AAABmcmFnbWVudCh2ZjI7dmYyOwAAAAUAAwALAAAAdXYAAAUABQAMAAAAZnJhZ0Nvb3JkAAAABQAEABAAAABteWNvbG9yAAUABgAZAAAAYml0UmF0ZUNvbG9yAAAAAAUAAwArAAAAcmVzAAUABQAtAAAAaVJlc29sdXRpb24ABQADADIAAABwb3MABQAFAEoAAABpbWFnZVBpeGVsAAAFAAQATgAAAGltYWdlAAAABQAFAFIAAABjb2xvckZhY3RvcgAFAAYAVAAAAG5ld1JNdWx0aXBsaWVyAAAFAAYAcwAAAG5ld0dNdWx0aXBsaWVyAAAFAAYAkgAAAG5ld0JNdWx0aXBsaWVyAAAFAAQAsgAAAG5ld1IAAAAABQAEALcAAABuZXdHAAAAAAUABAC8AAAAbmV3QgAAAAAFAAQAwQAAAGVyclIAAAAABQAEAMYAAABlcnJHAAAAAAUABADLAAAAZXJyQgAAAAAFAAYA0QAAAGZpbHRlcmVkQ29sb3IAAAAFAAMA4AAAAHV2AAAFAAYA4gAAAGdsX0ZyYWdDb29yZAAAAAAFAAUA5QAAAHJlc29sdXRpb24AAAUABADpAAAAX0NPTE9SXwAFAAQA6gAAAHBhcmFtAAAABQAEAOwAAABwYXJhbQAAAEcAAwANAAAAAAAAAEcAAwALAAAAAAAAAEcAAwAMAAAAAAAAAEcAAwAQAAAAAAAAAEcAAwASAAAAAAAAAEcAAwATAAAAAAAAAEcAAwAVAAAAAAAAAEcAAwAWAAAAAAAAAEcAAwAXAAAAAAAAAEcAAwAYAAAAAAAAAEcAAwAZAAAAAAAAAEcAAwAeAAAAAAAAAEcAAwAgAAAAAAAAAEcAAwAhAAAAAAAAAEcAAwAjAAAAAAAAAEcAAwAmAAAAAAAAAEcAAwAnAAAAAAAAAEcAAwAoAAAAAAAAAEcAAwApAAAAAAAAAEcAAwAqAAAAAAAAAEcAAwArAAAAAAAAAEcAAwAtAAAAAAAAAEcABAAtAAAAHgAAAAAAAABHAAMALgAAAAAAAABHAAMAMAAAAAAAAABHAAMAMQAAAAAAAABHAAMAMgAAAAAAAABHAAMAMwAAAAAAAABHAAMANAAAAAAAAABHAAMANQAAAAAAAABHAAMANgAAAAAAAABHAAMANwAAAAAAAABHAAMAOAAAAAAAAABHAAMAOgAAAAAAAABHAAMAPAAAAAAAAABHAAMAPQAAAAAAAABHAAMAPwAAAAAAAABHAAMAQAAAAAAAAABHAAMAQQAAAAAAAABHAAMAQgAAAAAAAABHAAMASgAAAAAAAABHAAMATgAAAAAAAABHAAQATgAAAB4AAAABAAAARwAEAE4AAAAiAAAAAAAAAEcABABOAAAAIQAAAAAAAABHAAMATwAAAAAAAABHAAMAUAAAAAAAAABHAAMAUQAAAAAAAABHAAMAUgAAAAAAAABHAAMAVAAAAAAAAABHAAMAVQAAAAAAAABHAAMAVwAAAAAAAABHAAMAWAAAAAAAAABHAAMAWQAAAAAAAABHAAMAXQAAAAAAAABHAAMAXwAAAAAAAABHAAMAYAAAAAAAAABHAAMAYQAAAAAAAABHAAMAYwAAAAAAAABHAAMAZAAAAAAAAABHAAMAZQAAAAAAAABHAAMAZgAAAAAAAABHAAMAZwAAAAAAAABHAAMAaQAAAAAAAABHAAMAawAAAAAAAABHAAMAbAAAAAAAAABHAAMAbQAAAAAAAABHAAMAbwAAAAAAAABHAAMAcAAAAAAAAABHAAMAcQAAAAAAAABHAAMAcgAAAAAAAABHAAMAcwAAAAAAAABHAAMAdAAAAAAAAABHAAMAdgAAAAAAAABHAAMAdwAAAAAAAABHAAMAeAAAAAAAAABHAAMAfAAAAAAAAABHAAMAfgAAAAAAAABHAAMAfwAAAAAAAABHAAMAgAAAAAAAAABHAAMAggAAAAAAAABHAAMAgwAAAAAAAABHAAMAhAAAAAAAAABHAAMAhQAAAAAAAABHAAMAhgAAAAAAAABHAAMAiAAAAAAAAABHAAMAigAAAAAAAABHAAMAiwAAAAAAAABHAAMAjAAAAAAAAABHAAMAjgAAAAAAAABHAAMAjwAAAAAAAABHAAMAkAAAAAAAAABHAAMAkQAAAAAAAABHAAMAkgAAAAAAAABHAAMAkwAAAAAAAABHAAMAlgAAAAAAAABHAAMAlwAAAAAAAABHAAMAmAAAAAAAAABHAAMAnAAAAAAAAABHAAMAngAAAAAAAABHAAMAnwAAAAAAAABHAAMAoAAAAAAAAABHAAMAogAAAAAAAABHAAMAowAAAAAAAABHAAMApAAAAAAAAABHAAMApQAAAAAAAABHAAMApgAAAAAAAABHAAMAqAAAAAAAAABHAAMAqgAAAAAAAABHAAMAqwAAAAAAAABHAAMArAAAAAAAAABHAAMArgAAAAAAAABHAAMArwAAAAAAAABHAAMAsAAAAAAAAABHAAMAsQAAAAAAAABHAAMAsgAAAAAAAABHAAMAswAAAAAAAABHAAMAtAAAAAAAAABHAAMAtQAAAAAAAABHAAMAtgAAAAAAAABHAAMAtwAAAAAAAABHAAMAuAAAAAAAAABHAAMAuQAAAAAAAABHAAMAugAAAAAAAABHAAMAuwAAAAAAAABHAAMAvAAAAAAAAABHAAMAvQAAAAAAAABHAAMAvgAAAAAAAABHAAMAvwAAAAAAAABHAAMAwAAAAAAAAABHAAMAwQAAAAAAAABHAAMAwwAAAAAAAABHAAMAxAAAAAAAAABHAAMAxQAAAAAAAABHAAMAxgAAAAAAAABHAAMAyAAAAAAAAABHAAMAyQAAAAAAAABHAAMAygAAAAAAAABHAAMAywAAAAAAAABHAAMAzQAAAAAAAABHAAMAzgAAAAAAAABHAAMAzwAAAAAAAABHAAMA0QAAAAAAAABHAAMA0gAAAAAAAABHAAMA0wAAAAAAAABHAAMA1AAAAAAAAABHAAMA1QAAAAAAAABHAAMA1gAAAAAAAABHAAMA1wAAAAAAAABHAAMA2AAAAAAAAABHAAMA2QAAAAAAAABHAAMA2gAAAAAAAABHAAMA2wAAAAAAAABHAAMA3AAAAAAAAABHAAMA3QAAAAAAAABHAAMA4AAAAAAAAABHAAQA4gAAAAsAAAAPAAAARwADAOUAAAAAAAAARwAEAOUAAAAeAAAAAgAAAEcAAwDmAAAAAAAAAEcAAwDpAAAAAAAAAEcABADpAAAAHgAAAAAAAABHAAMA6gAAAAAAAABHAAMA6wAAAAAAAABHAAMA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';
